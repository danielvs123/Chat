<!doctype html>
<html>
<head>
    <title>Socket.IO chat</title>
    <style>
        body{
            margin: 0;
            padding: 0;
        }
        .friend_div{
            width: 100%;height: 60px;border-bottom: 1px solid rgba(0,0,0,0.5);position: relative;overflow: hidden;
        }
        .friend_avatar{
            position:absolute;width: 50px;left: 10px;top: 5px;
        }
        .friend_title{
            position:absolute;left: 70px;top: 5px;font-size: 18px
        }
        .friend_text{
            position:absolute;left: 70px;bottom: 5px;font-size: 16px;color: gray;font-weight: lighter
        }
        #robot_outer{
            width: 100px;height: 150px;position: fixed;right: 0;border:1px solid gray;z-index: 99;
        }
        .robot{
            width: 100%;height: 50px;line-height: 50px;text-align: center;
        }
    </style>
    <style type="text/css">
        .sender{
            clear:both;
        }
        .sender div:nth-of-type(1){
            float: left;
        }
        .sender div:nth-of-type(2){
            background-color: aquamarine;
            float: left;
            margin: 0 20px 10px 15px;
            padding: 10px 10px 10px 0px;
            border-radius:7px;
        }

        .receiver div:first-child img,
        .sender div:first-child img{
            width:50px;
            height: 50px;
        }

        .receiver{
            clear:both;
        }
        .receiver div:nth-child(1){
            float: right;
        }
        .receiver div:nth-of-type(2){
            float:right;
            background-color: gold;
            margin: 0 10px 10px 20px;
            padding: 10px 0px 10px 10px;
            border-radius:7px;
        }

        .left_triangle{
            height:0px;
            width:0px;
            border-width:8px;
            border-style:solid;
            border-color:transparent aquamarine transparent transparent;
            position: relative;
            left:-16px;
            top:3px;
        }

        .right_triangle{
            height:0px;
            width:0px;
            border-width:8px;
            border-style:solid;
            border-color:transparent transparent transparent gold;
            position: relative;
            right:-16px;
            top:3px;
        }
    </style>
    <style type="text/css">
        #submit{
            width: 200px;height: 32px;position: fixed;bottom: 0;right: 0;background-color: cornflowerblue;text-align: center;line-height: 32px
        }
        #chat_input{
            width: 245px;height: 28px;position: fixed;bottom: 0;right: 200px;
        }
    </style>
</head>
<body>
<div id="robot_outer">
    <div class="robot">userIdDemo1</div>
    <div class="robot">userIdDemo2</div>
    <div class="robot">userIdDemo3</div>
</div>
<div style="width: 250px;height: 100vh;border-right: 1px solid rgba(0,0,0,0.5);position: fixed;top: 0;z-index: 999" id="friend">
</div>
<div style="width: 450px;height: 100vh;border-right: 1px solid rgba(0,0,0,0.5);position: fixed;top: 0;right: 0;border-left: 1px solid gray;display: none;overflow: scroll" id="chat">
    <div style="width: 100%;overflow: scroll" id="chatTotal"></div>
    <div style="width: 100%;height: 60px"></div>
    <input type="text" id="chat_input" />
    <div id="submit">发送</div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script type="application/javascript">
    var uid = "";
    var friend = document.getElementById("friend"),
        chatDiv = document.getElementById("chat"),
        chatTotal = document.getElementById("chatTotal");
        onShowedChat = "",
        personalInfo = {},
        friendsInfo = {},
        friendViewRenderer = new FriendViewStack(),
        liveChatRenderer = new FullChatInfo();
    // friendsInfo[data.data[i].id] = {
    //     name:data.data[i].name,
    //     avatar:data.data[i].avatar
    // };

    $(".robot").click(function () {
        $('#robot_outer').hide();
        uid =  this.innerText;
        document.title = uid;
        connect();
        getPersonalInfo();
        getFriendList();
    });


    //左侧好友列表的Stack();
    function FriendViewStack() {
        this.dataStore = [];
        this.push = function (data) {
            var arr = [],
                id = (data.toId === uid)?data.fromId:data.toId,
                //0代表接受 1代表送出
                type = (data.toId === uid)?0:1;
            for (var i = 0;i<this.dataStore.length;i++){
                arr.push(this.dataStore[i].id);
            }
            var indexOf = arr.indexOf(id);
            var tmpData = {};
            //就是没有这个数据
            if (indexOf === -1){
                tmpData = {
                    id: id,
                    type: type,
                    msg: data.msg
                }
            }else{
                tmpData = {
                    id: id,
                    type: type,
                    msg: data.msg
                };
                this.dataStore.splice(indexOf,1);
            }
            this.dataStore.unshift(tmpData);
        };
        //测试用
        this.print = function () {
            console.log(this.dataStore);
        };
        this.renderFriendView = function () {
            friend.innerHTML = "";
            for (var i = 0;i < this.dataStore.length ; i++){
                printFriendView({
                    avatar:friendsInfo[this.dataStore[i].id].avatar,
                    name:friendsInfo[this.dataStore[i].id].name,
                    msg:this.dataStore[i].msg,
                    id:this.dataStore[i].id
                })
            }
        }
    }

    function FullChatInfo() {
        this.dataStore = {};
        this.push = function (data) {
            var id = data.id,
                msg = data.msg,
                type = 0;
            if (this.dataStore[id] !== undefined){
                this.dataStore[id].push({
                    msg:msg,
                    type:type
                })
            } else{
                this.dataStore[id] = [{
                    msg:msg,
                    type:type
                }]
            }
        };
        //测试用
        this.print = function () {
            console.log(this.dataStore);
        };
        //绘制
        this.render = function (id) {
            $('#chat').show();
            if (this.dataStore[id]!==undefined){
                var dataset = this.dataStore[id];
                for (var i = 0;i<dataset.length;i++){
                    var type = dataset[i].type,
                        msg = dataset[i].msg;
                    if (type === 0){
                        getter(msg,id);
                    }else{
                        sender(msg);
                    }
                }
            }
        };
        //这里是用来添加新的聊天用的
        this.appendDiv = function (data) {
            getter(data.msg,data.id);
        }
    }

    function friendViewChat(data) {
        var div = document.createElement("div"),
            img = document.createElement("img"),
            span_title = document.createElement("span"),
            span_text = document.createElement("span");
        img.src = friendsInfo[data.id].avatar;
        span_title.innerText = friendsInfo[data.id].name;
        span_text.innerText = data.msg;
        div.className = "friend_div";
        img.className = "friend_avatar";
        span_text.className = "friend_text";
        span_title.className = "friend_title";
        friend.appendChild(div);
        div.appendChild(img);
        div.appendChild(span_title);
        div.appendChild(span_text);
    }

    function connect() {
        var socket = io();
        socket.emit("getPersonalInfo",{
            id:uid
        });
        var opposite = (uid === "userIdDemo1")?"userIdDemo2":"userIdDemo1";
        socket.emit("privateChat",opposite,new Date().getTime()+uid);
        socket.on("mailBox"+uid,function (msg) {
            var data = JSON.parse(msg),
                type = data.type;
            if (type === 1){
                for (var i = data.data.length-1;i>=0;i--){
                    friendViewRenderer.push(data.data[i]);
                    liveChatRenderer.push({
                        id:data.data[i].fromId,
                        msg:data.data[i].msg
                    });
                }
                friendViewRenderer.print();
                friendViewRenderer.renderFriendView();
            }else{
                var tmpData = {
                    fromId:data.data.id,
                    toId:uid,
                    msg:data.data.msg
                };
                friendViewRenderer.push(tmpData);
                friendViewRenderer.renderFriendView();
                liveChatRenderer.push({
                    id:data.data.id,
                    msg:data.data.msg
                });
                if (data.data.id === onShowedChat){
                    liveChatRenderer.appendDiv({
                        id:data.data.id,
                        msg:data.data.msg
                    });
                }
                // liveChatRenderer.print();
                // liveChatRenderer.render();
            }
        });
        //submit发送
        $chat_input = $('#chat_input');
        $('#submit').click(function () {
            var value = $chat_input.val();
            if (value === ""){
                alert("不能为空");
                return false;
            }
            socket.emit("privateChat",onShowedChat,value);
            sender(value);
            $chat_input.val("");
        });
    }

    function getFriendList() {
        //获取好友列表;
        $.ajax({
            type: 'POST',
            url: "getFriendList",
            data: {
                id:uid,
                accessToken:3333
            },
            success: function (data) {
                data = JSON.parse(data);
                if (data.status === 0){
                    for (var i = 0;i<data.length;i++){
                        //创建页面
                        printFriendView(data.data[i]);
                        //插入好友列表
                        friendsInfo[data.data[i].id] = {
                            name:data.data[i].name,
                            avatar:data.data[i].avatar
                        };
                    }
                }
            }
        });
    }

    function printFriendView(data) {
        var div = document.createElement("div"),
            img = document.createElement("img"),
            span_title = document.createElement("span"),
            span_text = document.createElement("span");
        img.src = data.avatar;
        span_title.innerText = data.name;
        if (data.msg === undefined){
            span_text.innerText = "";
        }else{
            span_text.innerText = data.msg;
        }
        div.className = "friend_div";
        div.id = data.id;
        div.onclick = function () {
            if(onShowedChat!==this.id){
                //需要重新绘制聊天
                liveChatRenderer.render(this.id);
                onShowedChat = this.id;
            }
        };
        img.className = "friend_avatar";
        span_text.className = "friend_text";
        span_title.className = "friend_title";
        friend.appendChild(div);
        div.appendChild(img);
        div.appendChild(span_title);
        div.appendChild(span_text);
    }

    function getPersonalInfo() {
        $.ajax({
            type: 'POST',
            url: "getPrivateInfo",
            data: {
                id:uid,
                accessToken:3333
            },
            success: function (data) {
                data = JSON.parse(data);
                if (data.status === 0){
                    personalInfo = {
                        name:data.data.name,
                        avatar:data.data.avatar
                    }
                }
            }
        });
    }

    function sender(msg) {
        var sender = document.createElement("div");
        sender.className = "sender";
        var avatar = document.createElement("div"),
            avatarImg = document.createElement("img");
        avatarImg.src = personalInfo.avatar;
        var chat = document.createElement("div"),
            triangle = document.createElement("div"),
            div = document.createElement("div"),
            span = document.createElement("span");
        triangle.className = "left_triangle";
        span.innerText = msg;
        chat.appendChild(triangle);
        chat.appendChild(div);
        div.appendChild(span);
        avatar.appendChild(avatarImg);
        sender.appendChild(avatar);
        sender.appendChild(chat);
        chatTotal.appendChild(sender);
    }

    function getter(msg,id) {
        var sender = document.createElement("div");
        sender.className = "receiver";
        var avatar = document.createElement("div"),
            avatarImg = document.createElement("img");
        avatarImg.src = friendsInfo[id].avatar;
        var chat = document.createElement("div"),
            triangle = document.createElement("div"),
            div = document.createElement("div"),
            span = document.createElement("span");
        span.innerText = msg;
        triangle.className = "right_triangle";
        chat.appendChild(triangle);
        chat.appendChild(div);
        div.appendChild(span);
        avatar.appendChild(avatarImg);
        sender.appendChild(avatar);
        sender.appendChild(chat);
        chatTotal.appendChild(sender);
    }
</script>
</body>
</html>